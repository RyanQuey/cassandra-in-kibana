# references: https://github.com/thelastpickle/docker-cassandra-bootstrap/blob/master/cassandra/config/filebeat.yml
output:
  logstash:
    enabled: true

    # reference container name given in docker-compose.yml (elk)
    # https://www.elastic.co/guide/en/beats/filebeat/current/logstash-output.html
    hosts: ["elk:5044"]
    timeout: 15

    # Disable ssl for now
    # ssl:
    #   certificate_authorities:
    #     - /etc/pki/tls/certs/logstash-beats.crt

# setup filebeat for kibana
setup: 
  kibana: 
    host: "http://elk:5601"

filebeat:
  inputs:
    - paths:
        # should get system.log, debug.log, gc.log.*.current, gremlin.log, output.log, maybe more depending on their setup
        - "/var/log/cassandra/*.log"
        - "/var/log/cassandra/gc.log*"
      document_type: cassandra_logs

#================================ Processors =====================================
# Configure processors to enhance or manipulate events generated by the beat.
# Borrowing from https://github.com/Anant/cassandra.toolkit/blob/dev/NodeAnalyzer/FilebeatSetup.MD#filebeatyml-usually-sits-in-etcfilebeat
# Use this web GUI to test: https://dissect-tester.jorgelbg.me/. There is also a CLI version here: https://github.com/jorgelbg/dissect-tester 

processors:
  # ( since we are not using a live host.. these are irrelevant) 
  #- add_host_metadata: ~ 
  #- add_cloud_metadata: ~
  #- add_docker_metadata: ~ 
  #- add_kubernetes_metadata: 
  
#------------------------------------- system messages 
  - dissect:
      tokenizer: "%{timestamp} %{+timestamp->} %{+timestamp} %{+timestamp} %{system-host-name} %{component}: %{message}"
      field: "message"
      target_prefix: "ingest"

  - dissect:
      tokenizer: "/%{}/%{}/%{}/%{}/%{}/cass.stat.%{incident-id}/%{host-name}/system/"
      field: "log.file.path"
      target_prefix: "ingest"

#-#------------------------------------ cassandra   
  - dissect:
      tokenizer: "%{loglevel} [%{component}] %{timestamp} %{+timestamp},%{} %{class}.%{}:%{} - %{message}"
      field: "message"
      target_prefix: "ingest"
  - dissect:
      tokenizer: "/%{}/%{}/%{}/%{}/%{}/cass.stat.%{incident-id}/%{host-name}/cassandra/"
      field: "log.file.path"
      target_prefix: "ingest"
  - timestamp:
      field: "ingest.timestamp"
      layouts:
        - '2006 Jan _2 15:04:05'
        - '2006-01-02 15:04:05'
      test:
        - '2020 Jun  8 02:40:01'
        - '2001 Jan 17 15:04:01'
        - '2019-06-22 16:33:51'
        - '2020-06-13 12:57:30'
      ignore_failure: true
      target_field: "@timestamp"
  - include_fields:
      fields: [ "ingest", "message","log","input" ]
